function parseUrl(e){let t={},n=/([^?=&]+)=([^?=&]+)/g;return e.replace(n,(function(){t[arguments[1]]=arguments[2]})),t}chrome.contextMenus.onClicked.addListener((function(e,t){"summarize_full_page"===e.menuItemId?(console.debug("[Summarize] 右键菜单触发 summarize_full_page"),chrome.tabs.sendMessage(t.id,{action:"getPageContent"},(function(e){chrome.runtime.lastError?console.warn("[Summarize] sendMessage(getPageContent) failed:",chrome.runtime.lastError.message):(console.debug("[Summarize] 收到页面内容",e),e&&e.content?summarizeContent(e.content).then((e=>{console.debug("[Summarize] 总结结果",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:e},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})).catch((e=>{console.error("[Summarize] 总结失败",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:"总结失败: "+e.message},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})):console.warn("[Summarize] 未获取到页面内容"))}))):chrome.tabs.create({url:e.menuItemId.replace("%s",encodeURIComponent(e.selectionText))})}));const defaultLLMConfig={llmEnableSummarize:!1,llmApiKey:"",llmEndpoint:"",llmPrompt:chrome.i18n.getMessage("llmPrompt")||"请用HTML格式总结以下网页内容，内容要有条理、分点、可直接用于innerHTML展示：\n%s",llmMaxTokens:chrome.i18n.getMessage("llmMaxTokens")||"32000",llmTemperature:chrome.i18n.getMessage("llmTemperature")||"0.5",llmSystemPrompt:chrome.i18n.getMessage("llmSystemPrompt")||"你是一个专业的中文内容总结助手，输出内容必须是可直接用于innerHTML展示的HTML片段。"};function addContextMenus(){chrome.contextMenus.removeAll();let e={engines:chrome.i18n.getMessage("defaultEnginesConfig")};chrome.storage.sync.get({...e,...defaultLLMConfig},(function(e){let t=JSON.parse(e.engines);t.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),console.debug("[Summarize] 添加右键菜单",e);const n=e.llmEnableSummarize,o=e.llmApiKey,r=e.llmEndpoint;n&&o&&r&&chrome.contextMenus.create({title:chrome.i18n.getMessage("summarizeFullPage")||"总结全文",id:"summarize_full_page",contexts:["page"]})}))}async function summarizeContent(e){return new Promise(((t,n)=>{chrome.storage.sync.get(defaultLLMConfig,(async function(o){try{if(!o.llmApiKey||!o.llmEndpoint)return void n(new Error("未配置API Key或Endpoint"));const r=o.llmApiKey,s=o.llmEndpoint,a=(o.llmPrompt||defaultLLMConfig.llmPrompt).replace("%s",e),m=parseInt(o.llmMaxTokens)||parseInt(defaultLLMConfig.llmMaxTokens),i=parseFloat(o.llmTemperature)||parseFloat(defaultLLMConfig.llmTemperature),l=o.llmSystemPrompt||defaultLLMConfig.llmSystemPrompt,c={messages:[{role:"system",content:l},{role:"user",content:a}],max_tokens:m,temperature:i,top_p:1,frequency_penalty:0,presence_penalty:0},u=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","api-key":r},body:JSON.stringify(c)});if(!u.ok){const e=await u.text();return void n(new Error("API请求失败: "+u.status+" "+e))}const g=await u.json();t(g.choices&&g.choices[0]&&g.choices[0].message&&g.choices[0].message.content?g.choices[0].message.content.trim():"未获取到总结内容")}catch(r){n(r)}}))}))}async function summarizeContentWithHistory(e){return new Promise(((t,n)=>{chrome.storage.sync.get(defaultLLMConfig,(async function(o){try{if(!o.llmApiKey||!o.llmEndpoint)return void n(new Error("未配置API Key或Endpoint"));const r=o.llmApiKey,s=o.llmEndpoint,a=parseInt(o.llmMaxTokens)||parseInt(defaultLLMConfig.llmMaxTokens),m=parseFloat(o.llmTemperature)||parseFloat(defaultLLMConfig.llmTemperature),i=o.llmSystemPrompt||defaultLLMConfig.llmSystemPrompt,l={messages:[{role:"system",content:i},...e],max_tokens:a,temperature:m,top_p:1,frequency_penalty:0,presence_penalty:0},c=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","api-key":r},body:JSON.stringify(l)});if(!c.ok){const e=await c.text();return void n(new Error("API请求失败: "+c.status+" "+e))}const u=await c.json();t(u.choices&&u.choices[0]&&u.choices[0].message&&u.choices[0].message.content?u.choices[0].message.content.trim():"未获取到回复内容")}catch(r){n(r)}}))}))}chrome.runtime.onStartup.addListener(addContextMenus),chrome.runtime.onInstalled.addListener(addContextMenus),chrome.runtime.onMessage.addListener((function(e,t,n){return Array.isArray(e)?(e.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),void n("done")):"chatWithLLM"===e.action&&Array.isArray(e.history)?(summarizeContentWithHistory(e.history).then((e=>{n({reply:e})})).catch((e=>{n({reply:"对话失败: "+e.message})})),!0):void 0})),chrome.commands.onCommand.addListener((function(e){"toggle-search"===e&&chrome.tabs.query({active:!0},(function(e){let t=e[0],n=parseUrl(t.url),o=t.url.split("/")[2].split(".")[1],r=n["wd"]||n["word"]||n["w"]||n["q"]||n["query"];if(r){let e={engines:chrome.i18n.getMessage("defaultEnginesConfig")};chrome.storage.sync.get(e,(function(e){let t=JSON.parse(e.engines);if(t.length<1)return void console.log("no engine");let n=!1,s=!1;t.forEach((function(e){if(!s&&e.name&&e.url&&e.inShortcuts){if(!0===n)return s=!0,void chrome.tabs.update({url:e.url.replace("%s",r)});e.domain=e.url.split("/")[2].split(".")[1],e.domain==o&&(n=!0)}})),!1===s&&chrome.tabs.update({url:t[0].url.replace("%s",r)})}))}}))}));