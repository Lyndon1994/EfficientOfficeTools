function parseUrl(e){let t={},o=/([^?=&]+)=([^?=&]+)/g;return e.replace(o,(function(){t[arguments[1]]=arguments[2]})),t}const processedRequests=new Map;chrome.contextMenus.onClicked.addListener((function(e,t){if(e.menuItemId&&e.menuItemId.startsWith("llm_chat_menu_")){const o=`${e.menuItemId}_${t.id}_${Date.now()}`;console.debug(`[LLM Chat] Menu clicked, requestId: ${o}`);const r=parseInt(e.menuItemId.replace("llm_chat_menu_",""));chrome.storage.sync.get({llmChatMenus:[]},(function(n){const s=Array.isArray(n.llmChatMenus)?n.llmChatMenus:[],a=s[r];if(!a)return;const i=(a.prompt||"").replace("{content}",e.selectionText||""),c=a.systemPrompt||"";chrome.tabs.sendMessage(t.id,{action:"showLLMChatDialog",requestId:o,menu:{id:a.id,name:a.name,prompt:i,systemPrompt:c,originalPrompt:a.prompt},selectionText:e.selectionText||""})}))}else"summarize_full_page"===e.menuItemId?(console.debug("[Summarize] 右键菜单触发 summarize_full_page"),chrome.tabs.sendMessage(t.id,{action:"getPageContent"},(function(e){chrome.runtime.lastError?console.warn("[Summarize] sendMessage(getPageContent) failed:",chrome.runtime.lastError.message):(console.debug("[Summarize] 收到页面内容",e),e&&e.content?summarizeContent(e.content).then((e=>{console.debug("[Summarize] 总结结果",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:e},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})).catch((e=>{console.error("[Summarize] 总结失败",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:"总结失败: "+e.message},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})):console.warn("[Summarize] 未获取到页面内容"))}))):chrome.tabs.create({url:e.menuItemId.replace("%s",encodeURIComponent(e.selectionText))})}));const defaultLLMConfig={llmEnableSummarize:!1,llmModels:"[]",llmPrompt:chrome.i18n.getMessage("llmPrompt")||"",llmSystemPrompt:chrome.i18n.getMessage("llmSystemPrompt")||""};function addContextMenus(){chrome.contextMenus.removeAll();let e={engines:chrome.i18n.getMessage("defaultEnginesConfig"),llmChatMenus:[]};chrome.storage.sync.get({...e,...defaultLLMConfig},(function(e){Array.isArray(e.llmChatMenus)&&e.llmChatMenus.forEach(((e,t)=>{e&&e.name&&e.prompt&&chrome.contextMenus.create({title:e.name,id:"llm_chat_menu_"+t,contexts:["selection"]})}));let t=JSON.parse(e.engines);t.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),console.debug("[Summarize] 添加右键菜单",e),e.llmEnableSummarize&&chrome.contextMenus.create({title:chrome.i18n.getMessage("summarizeFullPage")||"总结全文",id:"summarize_full_page",contexts:["page"]})}))}function buildConfig(e,t){const o=JSON.parse(JSON.stringify(e));function r(e){for(const o in e)"string"===typeof e[o]?e[o]=e[o].replace(/\${(.*?)}/g,((e,o)=>void 0!==t[o]?t[o]:"")):"object"===typeof e[o]&&null!==e[o]&&r(e[o])}if(o.bodyParams&&Object.prototype.hasOwnProperty.call(o.bodyParams,"messages")&&t.MESSAGES&&(o.bodyParams.messages=t.MESSAGES),o.bodyParams)for(const n in o.bodyParams)"messages"!==n&&("string"===typeof o.bodyParams[n]?o.bodyParams[n]=o.bodyParams[n].replace(/\${(.*?)}/g,((e,o)=>void 0!==t[o]?t[o]:"")):"object"===typeof o.bodyParams[n]&&null!==o.bodyParams[n]&&r(o.bodyParams[n]));for(const n in o)"bodyParams"!==n&&"string"===typeof o[n]&&(o[n]=o[n].replace(/\${(.*?)}/g,((e,o)=>void 0!==t[o]?t[o]:"")));return o}async function getActiveModelConfig(){return new Promise(((e,t)=>{chrome.storage.sync.get({llmModels:""},(function(t){let o={};try{"string"===typeof t.llmModels&&t.llmModels.trim()&&(o=JSON.parse(t.llmModels))}catch(r){}for(const[n,s]of Object.entries(o))if(s&&s.active)return void e({name:n,config:s});e(null)}))}))}async function callModel(e,t){const{name:o,config:r}=await getActiveModelConfig()||{};if(!r)throw new Error("No active model config found");const n=buildConfig(r,t);try{const e=await fetch(n.endpoint,{method:n.method||"POST",headers:n.headers||{},body:"GET"===n.method?void 0:JSON.stringify(n.bodyParams)}),t=await e.json();if("string"===typeof n.responseParser){if(!n.responseParser.startsWith("response."))return"";{let e=t;try{const t=n.responseParser.replace(/^response\./,"").split(".");for(let o=0;o<t.length;o++){let r=t[o];const n=r.match(/^(\w+)\[(\d+)\]$/);if(n){const t=n[1],o=Number(n[2]);if(e=e[t],!Array.isArray(e)||e.length<=o)return"";e=e[o]}else e=e[r];if(void 0===e||null===e)return""}return e}catch(s){return""}}}return t}catch(a){throw console.error(`${e||o} API Error:`,a),a}}async function summarizeContent(e){const t=await getActiveModelConfig();if(!t||!t.config)throw new Error("No active model config found");let o=await new Promise((e=>{chrome.storage.sync.get({llmPrompt:"",llmSystemPrompt:""},e)}));const r=(o.llmPrompt||"").replace("{content}",e),n=o.llmSystemPrompt||"";let s=[];t.config.bodyParams&&t.config.bodyParams.messages&&Array.isArray(t.config.bodyParams.messages)?s=t.config.bodyParams.messages.map((t=>{const o={};for(const r in t)"string"===typeof t[r]?o[r]=t[r].replace(/\${content}/g,e):o[r]=t[r];return o})):(n?s.push({role:"system",content:n}):t.config.systemPrompt&&s.push({role:"system",content:t.config.systemPrompt}),r&&s.push({role:"user",content:r}),s.push({role:"user",content:e}));const a={MESSAGES:s},i=await callModel(t.name,a);return"string"===typeof i?i:JSON.stringify(i)}async function summarizeContentWithHistory(e){const t=await getActiveModelConfig();if(!t||!t.config)throw new Error("No active model config found");let o=await new Promise((e=>{chrome.storage.sync.get({llmPrompt:"",llmSystemPrompt:""},e)}));const r=o.llmPrompt||"",n=o.llmSystemPrompt||"";let s=[];Array.isArray(e)&&e.length>0?s=e:(n?s.push({role:"system",content:n}):t.config.systemPrompt&&s.push({role:"system",content:t.config.systemPrompt}),r&&s.push({role:"user",content:r}));const a={MESSAGES:s},i=await callModel(t.name,a);return"string"===typeof i?i:JSON.stringify(i)}async function chatWithLLMMenu(e,t){const o=await getActiveModelConfig();if(!o||!o.config)throw new Error("No active model config found");let r=[];t&&t.length>0?r=t:(e.systemPrompt&&r.push({role:"system",content:e.systemPrompt}),r.push({role:"user",content:e.prompt}));const n={MESSAGES:r},s=await callModel(o.name,n);return"string"===typeof s?s:JSON.stringify(s)}chrome.runtime.onStartup.addListener(addContextMenus),chrome.runtime.onInstalled.addListener(addContextMenus),chrome.runtime.onMessage.addListener((function(e,t,o){if("updateMenus"===e.action)return chrome.contextMenus.removeAll(),Array.isArray(e.llmChatMenus)&&e.llmChatMenus.forEach(((e,t)=>{e&&e.name&&e.prompt&&chrome.contextMenus.create({title:e.name,id:"llm_chat_menu_"+t,contexts:["selection"]})})),Array.isArray(e.enginesMeta)&&e.enginesMeta.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),void o("done");if("chatWithLLM"===e.action&&Array.isArray(e.history))return(async()=>{try{const r=new Promise(((e,t)=>setTimeout((()=>t(new Error("请求超时，请重试"))),6e4))),n=await Promise.race([summarizeContentWithHistory(e.history),r]);try{o({reply:n})}catch(t){console.error("Failed to send response, message port might be closed:",t)}}catch(r){console.error("chatWithLLM error:",r);try{o({reply:"对话失败: "+r.message})}catch(t){console.error("Failed to send error response, message port might be closed:",t)}}})(),!0;if("chatWithLLMMenu"===e.action&&e.menu){const t=JSON.stringify({action:e.action,menu:e.menu?.name,prompt:e.history?.[0]?.content}),r=Date.now(),n=processedRequests.get(t);if(n&&r-n<2e3)return console.warn("[LLM Chat] Rejecting duplicate request:",t),o({reply:"正在处理中，请稍候...",duplicate:!0}),!0;if(processedRequests.set(t,r),r%1e4<1e3)for(const[e,o]of processedRequests.entries())r-o>1e4&&processedRequests.delete(e);return(async()=>{try{console.debug("[LLM Chat] Processing request:",t);const n=new Promise(((e,t)=>setTimeout((()=>t(new Error("请求超时，请重试"))),6e4))),s=await Promise.race([chatWithLLMMenu(e.menu,e.history),n]);try{o({reply:s})}catch(r){console.error("Failed to send response, message port might be closed:",r)}}catch(n){console.error("chatWithLLMMenu error:",n);try{o({reply:"对话失败: "+n.message})}catch(r){console.error("Failed to send error response, message port might be closed:",r)}}finally{processedRequests.delete(t)}})(),!0}})),chrome.commands.onCommand.addListener((function(e){"toggle-search"===e&&chrome.tabs.query({active:!0},(function(e){let t=e[0],o=parseUrl(t.url),r=t.url.split("/")[2].split(".")[1],n=o["wd"]||o["word"]||o["w"]||o["q"]||o["query"];if(n){let e={engines:chrome.i18n.getMessage("defaultEnginesConfig")};chrome.storage.sync.get(e,(function(e){let t=JSON.parse(e.engines);if(t.length<1)return void console.log("no engine");let o=!1,s=!1;t.forEach((function(e){if(!s&&e.name&&e.url&&e.inShortcuts){if(!0===o)return s=!0,void chrome.tabs.update({url:e.url.replace("%s",n)});e.domain=e.url.split("/")[2].split(".")[1],e.domain==r&&(o=!0)}})),!1===s&&chrome.tabs.update({url:t[0].url.replace("%s",n)})}))}}))}));