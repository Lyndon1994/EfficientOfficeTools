function parseUrl(e){let t={},o=/([^?=&]+)=([^?=&]+)/g;return e.replace(o,(function(){t[arguments[1]]=arguments[2]})),t}chrome.contextMenus.onClicked.addListener((function(e,t){if(e.menuItemId&&e.menuItemId.startsWith("llm_chat_menu_")){const o=parseInt(e.menuItemId.replace("llm_chat_menu_",""));chrome.storage.sync.get({llmChatMenus:[]},(function(n){const r=Array.isArray(n.llmChatMenus)?n.llmChatMenus:[],s=r[o];if(!s)return;const a=(s.prompt||"").replace("{content}",e.selectionText||""),m=s.systemPrompt||"";chrome.tabs.sendMessage(t.id,{action:"showLLMChatDialog",menu:{id:s.id,name:s.name,prompt:a,systemPrompt:m,originalPrompt:s.prompt},selectionText:e.selectionText||""})}))}else"summarize_full_page"===e.menuItemId?(console.debug("[Summarize] 右键菜单触发 summarize_full_page"),chrome.tabs.sendMessage(t.id,{action:"getPageContent"},(function(e){chrome.runtime.lastError?console.warn("[Summarize] sendMessage(getPageContent) failed:",chrome.runtime.lastError.message):(console.debug("[Summarize] 收到页面内容",e),e&&e.content?summarizeContent(e.content).then((e=>{console.debug("[Summarize] 总结结果",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:e},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})).catch((e=>{console.error("[Summarize] 总结失败",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:"总结失败: "+e.message},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})):console.warn("[Summarize] 未获取到页面内容"))}))):chrome.tabs.create({url:e.menuItemId.replace("%s",encodeURIComponent(e.selectionText))})}));const defaultLLMConfig={llmEnableSummarize:!1,llmModels:"[]",llmPrompt:chrome.i18n.getMessage("llmPrompt")||"",llmSystemPrompt:chrome.i18n.getMessage("llmSystemPrompt")||""};function addContextMenus(){chrome.contextMenus.removeAll();let e={engines:chrome.i18n.getMessage("defaultEnginesConfig"),llmChatMenus:[]};chrome.storage.sync.get({...e,...defaultLLMConfig},(function(e){Array.isArray(e.llmChatMenus)&&e.llmChatMenus.forEach(((e,t)=>{e&&e.name&&e.prompt&&chrome.contextMenus.create({title:e.name,id:"llm_chat_menu_"+t,contexts:["selection"]})}));let t=JSON.parse(e.engines);t.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),console.debug("[Summarize] 添加右键菜单",e),e.llmEnableSummarize&&chrome.contextMenus.create({title:chrome.i18n.getMessage("summarizeFullPage")||"总结全文",id:"summarize_full_page",contexts:["page"]})}))}function buildConfig(e,t){const o=JSON.parse(JSON.stringify(e));function n(e){for(const o in e)"string"===typeof e[o]?e[o]=e[o].replace(/\${(.*?)}/g,((e,o)=>void 0!==t[o]?t[o]:"")):"object"===typeof e[o]&&null!==e[o]&&n(e[o])}if(o.bodyParams&&Object.prototype.hasOwnProperty.call(o.bodyParams,"messages")&&t.MESSAGES&&(o.bodyParams.messages=t.MESSAGES),o.bodyParams)for(const r in o.bodyParams)"messages"!==r&&("string"===typeof o.bodyParams[r]?o.bodyParams[r]=o.bodyParams[r].replace(/\${(.*?)}/g,((e,o)=>void 0!==t[o]?t[o]:"")):"object"===typeof o.bodyParams[r]&&null!==o.bodyParams[r]&&n(o.bodyParams[r]));for(const r in o)"bodyParams"!==r&&"string"===typeof o[r]&&(o[r]=o[r].replace(/\${(.*?)}/g,((e,o)=>void 0!==t[o]?t[o]:"")));return o}async function getActiveModelConfig(){return new Promise(((e,t)=>{chrome.storage.sync.get({llmModels:""},(function(t){let o={};try{"string"===typeof t.llmModels&&t.llmModels.trim()&&(o=JSON.parse(t.llmModels))}catch(n){}for(const[r,s]of Object.entries(o))if(s&&s.active)return void e({name:r,config:s});e(null)}))}))}async function callModel(e,t){const{name:o,config:n}=await getActiveModelConfig()||{};if(!n)throw new Error("No active model config found");const r=buildConfig(n,t);try{const e=await fetch(r.endpoint,{method:r.method||"POST",headers:r.headers||{},body:"GET"===r.method?void 0:JSON.stringify(r.bodyParams)}),t=await e.json();if("string"===typeof r.responseParser){if(!r.responseParser.startsWith("response."))return"";{let e=t;try{const t=r.responseParser.replace(/^response\./,"").split(".");for(let o=0;o<t.length;o++){let n=t[o];const r=n.match(/^(\w+)\[(\d+)\]$/);if(r){const t=r[1],o=Number(r[2]);if(e=e[t],!Array.isArray(e)||e.length<=o)return"";e=e[o]}else e=e[n];if(void 0===e||null===e)return""}return e}catch(s){return""}}}return t}catch(a){throw console.error(`${e||o} API Error:`,a),a}}async function summarizeContent(e){const t=await getActiveModelConfig();if(!t||!t.config)throw new Error("No active model config found");let o=await new Promise((e=>{chrome.storage.sync.get({llmPrompt:"",llmSystemPrompt:""},e)}));const n=(o.llmPrompt||"").replace("{content}",e),r=o.llmSystemPrompt||"";let s=[];t.config.bodyParams&&t.config.bodyParams.messages&&Array.isArray(t.config.bodyParams.messages)?s=t.config.bodyParams.messages.map((t=>{const o={};for(const n in t)"string"===typeof t[n]?o[n]=t[n].replace(/\${content}/g,e):o[n]=t[n];return o})):(r?s.push({role:"system",content:r}):t.config.systemPrompt&&s.push({role:"system",content:t.config.systemPrompt}),n&&s.push({role:"user",content:n}),s.push({role:"user",content:e}));const a={MESSAGES:s},m=await callModel(t.name,a);return"string"===typeof m?m:JSON.stringify(m)}async function summarizeContentWithHistory(e){const t=await getActiveModelConfig();if(!t||!t.config)throw new Error("No active model config found");let o=await new Promise((e=>{chrome.storage.sync.get({llmPrompt:"",llmSystemPrompt:""},e)}));const n=o.llmPrompt||"",r=o.llmSystemPrompt||"";let s=[];Array.isArray(e)&&e.length>0?s=e:(r?s.push({role:"system",content:r}):t.config.systemPrompt&&s.push({role:"system",content:t.config.systemPrompt}),n&&s.push({role:"user",content:n}));const a={MESSAGES:s},m=await callModel(t.name,a);return"string"===typeof m?m:JSON.stringify(m)}async function chatWithLLMMenu(e,t){const o=await getActiveModelConfig();if(!o||!o.config)throw new Error("No active model config found");let n=[];t&&t.length>0?n=t:(e.systemPrompt&&n.push({role:"system",content:e.systemPrompt}),n.push({role:"user",content:e.prompt}));const r={MESSAGES:n},s=await callModel(o.name,r);return"string"===typeof s?s:JSON.stringify(s)}chrome.runtime.onStartup.addListener(addContextMenus),chrome.runtime.onInstalled.addListener(addContextMenus),chrome.runtime.onMessage.addListener((function(e,t,o){return Array.isArray(e)?(e.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),void o("done")):"chatWithLLM"===e.action&&Array.isArray(e.history)?(summarizeContentWithHistory(e.history).then((e=>{o({reply:e})})).catch((e=>{o({reply:"对话失败: "+e.message})})),!0):"chatWithLLMMenu"===e.action&&e.menu?(chatWithLLMMenu(e.menu,e.history).then((e=>{o({reply:e})})).catch((e=>{o({reply:"对话失败: "+e.message})})),!0):void 0})),chrome.commands.onCommand.addListener((function(e){"toggle-search"===e&&chrome.tabs.query({active:!0},(function(e){let t=e[0],o=parseUrl(t.url),n=t.url.split("/")[2].split(".")[1],r=o["wd"]||o["word"]||o["w"]||o["q"]||o["query"];if(r){let e={engines:chrome.i18n.getMessage("defaultEnginesConfig")};chrome.storage.sync.get(e,(function(e){let t=JSON.parse(e.engines);if(t.length<1)return void console.log("no engine");let o=!1,s=!1;t.forEach((function(e){if(!s&&e.name&&e.url&&e.inShortcuts){if(!0===o)return s=!0,void chrome.tabs.update({url:e.url.replace("%s",r)});e.domain=e.url.split("/")[2].split(".")[1],e.domain==n&&(o=!0)}})),!1===s&&chrome.tabs.update({url:t[0].url.replace("%s",r)})}))}}))}));