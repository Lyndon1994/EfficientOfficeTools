function parseUrl(e){let t={},r=/([^?=&]+)=([^?=&]+)/g;return e.replace(r,(function(){t[arguments[1]]=arguments[2]})),t}const processedRequests=new Map;chrome.contextMenus.onClicked.addListener((function(e,t){if(e.menuItemId&&e.menuItemId.startsWith("llm_chat_menu_")){const r=`${e.menuItemId}_${t.id}_${Date.now()}`;console.debug(`[LLM Chat] Menu clicked, requestId: ${r}`);const o=parseInt(e.menuItemId.replace("llm_chat_menu_",""));chrome.storage.sync.get({llmChatMenus:[]},(function(n){const s=Array.isArray(n.llmChatMenus)?n.llmChatMenus:[],a=s[o];if(!a)return;const i=(a.prompt||"").replace("{content}",e.selectionText||""),c=a.systemPrompt||"";chrome.tabs.sendMessage(t.id,{action:"showLLMChatDialog",requestId:r,menu:{id:a.id,name:a.name,prompt:i,systemPrompt:c,originalPrompt:a.prompt},selectionText:e.selectionText||""})}))}else"summarize_full_page"===e.menuItemId?(console.debug("[Summarize] 右键菜单触发 summarize_full_page"),chrome.tabs.sendMessage(t.id,{action:"getPageContent"},(function(e){chrome.runtime.lastError?console.warn("[Summarize] sendMessage(getPageContent) failed:",chrome.runtime.lastError.message):(console.debug("[Summarize] 收到页面内容",e),e&&e.content?summarizeContent(e.content).then((({result:e,messages:r})=>{console.debug("[Summarize] 总结结果",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:e,messages:r},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})).catch((e=>{console.error("[Summarize] 总结失败",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:"总结失败: "+e.message},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})):console.warn("[Summarize] 未获取到页面内容"))}))):chrome.tabs.create({url:e.menuItemId.replace("%s",encodeURIComponent(e.selectionText))})}));const defaultLLMConfig={llmEnableSummarize:!1,llmModels:"[]",llmPrompt:chrome.i18n.getMessage("llmPrompt")||"",llmSystemPrompt:chrome.i18n.getMessage("llmSystemPrompt")||""};function addContextMenus(){chrome.contextMenus.removeAll();let e={engines:chrome.i18n.getMessage("defaultEnginesConfig"),llmChatMenus:[]};chrome.storage.sync.get({...e,...defaultLLMConfig},(function(e){Array.isArray(e.llmChatMenus)&&e.llmChatMenus.forEach(((e,t)=>{e&&e.name&&e.prompt&&chrome.contextMenus.create({title:e.name,id:"llm_chat_menu_"+t,contexts:["selection"]})}));let t=JSON.parse(e.engines);t.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),console.debug("[Summarize] 添加右键菜单",e),e.llmEnableSummarize&&chrome.contextMenus.create({title:chrome.i18n.getMessage("summarizeFullPage")||"总结全文",id:"summarize_full_page",contexts:["page"]})}))}function buildConfig(e,t){const r=JSON.parse(JSON.stringify(e));function o(e){for(const r in e)"string"===typeof e[r]?e[r]=e[r].replace(/\${(.*?)}/g,((e,r)=>void 0!==t[r]?t[r]:"")):"object"===typeof e[r]&&null!==e[r]&&o(e[r])}if(r.bodyParams&&Object.prototype.hasOwnProperty.call(r.bodyParams,"messages")&&t.MESSAGES&&(r.bodyParams.messages=t.MESSAGES),r.bodyParams)for(const n in r.bodyParams)"messages"!==n&&("string"===typeof r.bodyParams[n]?r.bodyParams[n]=r.bodyParams[n].replace(/\${(.*?)}/g,((e,r)=>void 0!==t[r]?t[r]:"")):"object"===typeof r.bodyParams[n]&&null!==r.bodyParams[n]&&o(r.bodyParams[n]));for(const n in r)"bodyParams"!==n&&"string"===typeof r[n]&&(r[n]=r[n].replace(/\${(.*?)}/g,((e,r)=>void 0!==t[r]?t[r]:"")));return r}async function getActiveModelConfig(){return new Promise(((e,t)=>{chrome.storage.sync.get({llmModels:""},(function(t){let r={};try{"string"===typeof t.llmModels&&t.llmModels.trim()&&(r=JSON.parse(t.llmModels))}catch(o){}for(const[n,s]of Object.entries(r))if(s&&s.active)return void e({name:n,config:s});e(null)}))}))}async function callModel(e,t){const{name:r,config:o}=await getActiveModelConfig()||{};if(!o)throw new Error("No active model config found");const n=buildConfig(o,t);try{const e=await fetch(n.endpoint,{method:n.method||"POST",headers:n.headers||{},body:"GET"===n.method?void 0:JSON.stringify(n.bodyParams)}),t=await e.json();if("string"===typeof n.responseParser){if(!n.responseParser.startsWith("response."))return"";{let e=t;try{const t=n.responseParser.replace(/^response\./,"").split(".");for(let r=0;r<t.length;r++){let o=t[r];const n=o.match(/^(\w+)\[(\d+)\]$/);if(n){const t=n[1],r=Number(n[2]);if(e=e[t],!Array.isArray(e)||e.length<=r)return"";e=e[r]}else e=e[o];if(void 0===e||null===e)return""}return e}catch(s){return""}}}return t}catch(a){throw console.error(`${e||r} API Error:`,a),a}}async function summarizeContent(e){const t=await getActiveModelConfig();if(!t||!t.config)throw new Error("No active model config found");let r=await new Promise((e=>{chrome.storage.sync.get({llmPrompt:"",llmSystemPrompt:""},e)}));const o=(r.llmPrompt||"").replace("{content}",e),n=r.llmSystemPrompt||"";let s=[];n&&s.push({role:"system",content:n}),o&&s.push({role:"user",content:o});const a={MESSAGES:s},i=await callModel(t.name,a);return{result:"string"===typeof i?i:JSON.stringify(i),messages:s}}async function summarizeContentWithHistory(e){const t=await getActiveModelConfig();if(!t||!t.config)throw new Error("No active model config found");let r=await new Promise((e=>{chrome.storage.sync.get({llmPrompt:"",llmSystemPrompt:""},e)}));const o=r.llmPrompt||"",n=r.llmSystemPrompt||"";let s=[];Array.isArray(e)&&e.length>0?s=e:(n&&s.push({role:"system",content:n}),o&&s.push({role:"user",content:o}));const a={MESSAGES:s},i=await callModel(t.name,a);return"string"===typeof i?i:JSON.stringify(i)}async function chatWithLLMMenu(e,t){const r=await getActiveModelConfig();if(!r||!r.config)throw new Error("No active model config found");let o=[];t&&t.length>0?o=t:(e.systemPrompt&&o.push({role:"system",content:e.systemPrompt}),o.push({role:"user",content:e.prompt}));const n={MESSAGES:o},s=await callModel(r.name,n);return"string"===typeof s?s:JSON.stringify(s)}chrome.runtime.onStartup.addListener(addContextMenus),chrome.runtime.onInstalled.addListener(addContextMenus),chrome.runtime.onMessage.addListener((function(e,t,r){if("updateMenus"===e.action)return chrome.contextMenus.removeAll(),Array.isArray(e.llmChatMenus)&&e.llmChatMenus.forEach(((e,t)=>{e&&e.name&&e.prompt&&chrome.contextMenus.create({title:e.name,id:"llm_chat_menu_"+t,contexts:["selection"]})})),Array.isArray(e.enginesMeta)&&e.enginesMeta.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),void r("done");if("chatWithLLM"===e.action&&Array.isArray(e.history))return(async()=>{try{const o=new Promise(((e,t)=>setTimeout((()=>t(new Error("请求超时，请重试"))),6e4))),n=await Promise.race([summarizeContentWithHistory(e.history),o]);try{r({reply:n})}catch(t){console.error("Failed to send response, message port might be closed:",t)}}catch(o){console.error("chatWithLLM error:",o);try{r({reply:"对话失败: "+o.message})}catch(t){console.error("Failed to send error response, message port might be closed:",t)}}})(),!0;if("chatWithLLMMenu"===e.action&&e.menu){const t=JSON.stringify({action:e.action,menu:e.menu?.name,prompt:e.history?.[0]?.content}),o=Date.now(),n=processedRequests.get(t);if(n&&o-n<2e3)return console.warn("[LLM Chat] Rejecting duplicate request:",t),r({reply:"正在处理中，请稍候...",duplicate:!0}),!0;if(processedRequests.set(t,o),o%1e4<1e3)for(const[e,r]of processedRequests.entries())o-r>1e4&&processedRequests.delete(e);return(async()=>{try{console.debug("[LLM Chat] Processing request:",t);const n=new Promise(((e,t)=>setTimeout((()=>t(new Error("请求超时，请重试"))),6e4))),s=await Promise.race([chatWithLLMMenu(e.menu,e.history),n]);try{r({reply:s})}catch(o){console.error("Failed to send response, message port might be closed:",o)}}catch(n){console.error("chatWithLLMMenu error:",n);try{r({reply:"对话失败: "+n.message})}catch(o){console.error("Failed to send error response, message port might be closed:",o)}}finally{processedRequests.delete(t)}})(),!0}})),chrome.commands.onCommand.addListener((function(e){"toggle-search"===e&&chrome.tabs.query({active:!0},(function(e){let t=e[0],r=parseUrl(t.url),o=t.url.split("/")[2].split(".")[1],n=r["wd"]||r["word"]||r["w"]||r["q"]||r["query"];if(n){let e={engines:chrome.i18n.getMessage("defaultEnginesConfig")};chrome.storage.sync.get(e,(function(e){let t=JSON.parse(e.engines);if(t.length<1)return void console.log("no engine");let r=!1,s=!1;t.forEach((function(e){if(!s&&e.name&&e.url&&e.inShortcuts){if(!0===r)return s=!0,void chrome.tabs.update({url:e.url.replace("%s",n)});e.domain=e.url.split("/")[2].split(".")[1],e.domain==o&&(r=!0)}})),!1===s&&chrome.tabs.update({url:t[0].url.replace("%s",n)})}))}}))}));