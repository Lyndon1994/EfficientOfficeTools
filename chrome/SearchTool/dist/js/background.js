function parseUrl(e){let t={},n=/([^?=&]+)=([^?=&]+)/g;return e.replace(n,(function(){t[arguments[1]]=arguments[2]})),t}chrome.contextMenus.onClicked.addListener((function(e,t){if(e.menuItemId&&e.menuItemId.startsWith("llm_chat_menu_")){const n=parseInt(e.menuItemId.replace("llm_chat_menu_",""));chrome.storage.sync.get({llmChatMenus:[]},(function(o){const r=Array.isArray(o.llmChatMenus)?o.llmChatMenus:[],s=r[n];if(!s)return;const a=(s.prompt||"").replace("{content}",e.selectionText||""),m=s.systemPrompt||"";chrome.tabs.sendMessage(t.id,{action:"showLLMChatDialog",menu:{id:s.id,name:s.name,prompt:a,systemPrompt:m,originalPrompt:s.prompt},selectionText:e.selectionText||""})}))}else"summarize_full_page"===e.menuItemId?(console.debug("[Summarize] 右键菜单触发 summarize_full_page"),chrome.tabs.sendMessage(t.id,{action:"getPageContent"},(function(e){chrome.runtime.lastError?console.warn("[Summarize] sendMessage(getPageContent) failed:",chrome.runtime.lastError.message):(console.debug("[Summarize] 收到页面内容",e),e&&e.content?summarizeContent(e.content).then((e=>{console.debug("[Summarize] 总结结果",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:e},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})).catch((e=>{console.error("[Summarize] 总结失败",e),chrome.tabs.sendMessage(t.id,{action:"showSummaryDialog",summary:"总结失败: "+e.message},(function(e){chrome.runtime.lastError&&console.warn("[Summarize] sendMessage(showSummaryDialog) failed:",chrome.runtime.lastError.message)}))})):console.warn("[Summarize] 未获取到页面内容"))}))):chrome.tabs.create({url:e.menuItemId.replace("%s",encodeURIComponent(e.selectionText))})}));const defaultLLMConfig={llmEnableSummarize:!1,llmModels:"[]",llmPrompt:chrome.i18n.getMessage("llmPrompt")||"",llmSystemPrompt:chrome.i18n.getMessage("llmSystemPrompt")||""};function addContextMenus(){chrome.contextMenus.removeAll();let e={engines:chrome.i18n.getMessage("defaultEnginesConfig"),llmChatMenus:[]};chrome.storage.sync.get({...e,...defaultLLMConfig},(function(e){Array.isArray(e.llmChatMenus)&&e.llmChatMenus.forEach(((e,t)=>{e&&e.name&&e.prompt&&chrome.contextMenus.create({title:e.name,id:"llm_chat_menu_"+t,contexts:["selection"]})}));let t=JSON.parse(e.engines);t.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),console.debug("[Summarize] 添加右键菜单",e),e.llmEnableSummarize&&chrome.contextMenus.create({title:chrome.i18n.getMessage("summarizeFullPage")||"总结全文",id:"summarize_full_page",contexts:["page"]})}))}function buildConfig(e,t){const n=JSON.parse(JSON.stringify(e));function o(e){for(const n in e)"string"===typeof e[n]?e[n]=e[n].replace(/\${(.*?)}/g,((e,n)=>void 0!==t[n]?t[n]:"")):"object"===typeof e[n]&&null!==e[n]&&o(e[n])}if(n.bodyParams&&Object.prototype.hasOwnProperty.call(n.bodyParams,"messages")&&t.MESSAGES&&(n.bodyParams.messages=t.MESSAGES),n.bodyParams)for(const r in n.bodyParams)"messages"!==r&&("string"===typeof n.bodyParams[r]?n.bodyParams[r]=n.bodyParams[r].replace(/\${(.*?)}/g,((e,n)=>void 0!==t[n]?t[n]:"")):"object"===typeof n.bodyParams[r]&&null!==n.bodyParams[r]&&o(n.bodyParams[r]));for(const r in n)"bodyParams"!==r&&"string"===typeof n[r]&&(n[r]=n[r].replace(/\${(.*?)}/g,((e,n)=>void 0!==t[n]?t[n]:"")));return n}async function getActiveModelConfig(){return new Promise(((e,t)=>{chrome.storage.sync.get({llmModels:""},(function(t){let n={};try{"string"===typeof t.llmModels&&t.llmModels.trim()&&(n=JSON.parse(t.llmModels))}catch(o){}for(const[r,s]of Object.entries(n))if(s&&s.active)return void e({name:r,config:s});e(null)}))}))}async function callModel(e,t){const{name:n,config:o}=await getActiveModelConfig()||{};if(!o)throw new Error("No active model config found");const r=buildConfig(o,t);try{const e=await fetch(r.endpoint,{method:r.method||"POST",headers:r.headers||{},body:"GET"===r.method?void 0:JSON.stringify(r.bodyParams)}),t=await e.json();if("string"===typeof r.responseParser){if(!r.responseParser.startsWith("response."))return"";{let e=t;try{const t=r.responseParser.replace(/^response\./,"").split(".");for(let n=0;n<t.length;n++){let o=t[n];const r=o.match(/^(\w+)\[(\d+)\]$/);if(r){const t=r[1],n=Number(r[2]);if(e=e[t],!Array.isArray(e)||e.length<=n)return"";e=e[n]}else e=e[o];if(void 0===e||null===e)return""}return e}catch(s){return""}}}return t}catch(a){throw console.error(`${e||n} API Error:`,a),a}}async function summarizeContent(e){const t=await getActiveModelConfig();if(!t||!t.config)throw new Error("No active model config found");let n=await new Promise((e=>{chrome.storage.sync.get({llmPrompt:"",llmSystemPrompt:""},e)}));const o=(n.llmPrompt||"").replace("{content}",e),r=n.llmSystemPrompt||"";let s=[];t.config.bodyParams&&t.config.bodyParams.messages&&Array.isArray(t.config.bodyParams.messages)?s=t.config.bodyParams.messages.map((t=>{const n={};for(const o in t)"string"===typeof t[o]?n[o]=t[o].replace(/\${content}/g,e):n[o]=t[o];return n})):(r?s.push({role:"system",content:r}):t.config.systemPrompt&&s.push({role:"system",content:t.config.systemPrompt}),o&&s.push({role:"user",content:o}),s.push({role:"user",content:e}));const a={MESSAGES:s},m=await callModel(t.name,a);return"string"===typeof m?m:JSON.stringify(m)}async function summarizeContentWithHistory(e){const t=await getActiveModelConfig();if(!t||!t.config)throw new Error("No active model config found");let n=await new Promise((e=>{chrome.storage.sync.get({llmPrompt:"",llmSystemPrompt:""},e)}));const o=n.llmPrompt||"",r=n.llmSystemPrompt||"";let s=[];Array.isArray(e)&&e.length>0?s=e:(r?s.push({role:"system",content:r}):t.config.systemPrompt&&s.push({role:"system",content:t.config.systemPrompt}),o&&s.push({role:"user",content:o}));const a={MESSAGES:s},m=await callModel(t.name,a);return"string"===typeof m?m:JSON.stringify(m)}async function chatWithLLMMenu(e,t){const n=await getActiveModelConfig();if(!n||!n.config)throw new Error("No active model config found");let o=[];t&&t.length>0?o=t:(e.systemPrompt&&o.push({role:"system",content:e.systemPrompt}),o.push({role:"user",content:e.prompt}));const r={MESSAGES:o},s=await callModel(n.name,r);return"string"===typeof s?s:JSON.stringify(s)}chrome.runtime.onStartup.addListener(addContextMenus),chrome.runtime.onInstalled.addListener(addContextMenus),chrome.runtime.onMessage.addListener((function(e,t,n){return"updateMenus"===e.action?(chrome.contextMenus.removeAll(),Array.isArray(e.llmChatMenus)&&e.llmChatMenus.forEach(((e,t)=>{e&&e.name&&e.prompt&&chrome.contextMenus.create({title:e.name,id:"llm_chat_menu_"+t,contexts:["selection"]})})),Array.isArray(e.enginesMeta)&&e.enginesMeta.forEach((function(e){e.name&&e.url&&e.inRight&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchFor",e.name),id:e.url,contexts:["selection"]})})),void n("done")):"chatWithLLM"===e.action&&Array.isArray(e.history)?(summarizeContentWithHistory(e.history).then((e=>{n({reply:e})})).catch((e=>{n({reply:"对话失败: "+e.message})})),!0):"chatWithLLMMenu"===e.action&&e.menu?(chatWithLLMMenu(e.menu,e.history).then((e=>{n({reply:e})})).catch((e=>{n({reply:"对话失败: "+e.message})})),!0):void 0})),chrome.commands.onCommand.addListener((function(e){"toggle-search"===e&&chrome.tabs.query({active:!0},(function(e){let t=e[0],n=parseUrl(t.url),o=t.url.split("/")[2].split(".")[1],r=n["wd"]||n["word"]||n["w"]||n["q"]||n["query"];if(r){let e={engines:chrome.i18n.getMessage("defaultEnginesConfig")};chrome.storage.sync.get(e,(function(e){let t=JSON.parse(e.engines);if(t.length<1)return void console.log("no engine");let n=!1,s=!1;t.forEach((function(e){if(!s&&e.name&&e.url&&e.inShortcuts){if(!0===n)return s=!0,void chrome.tabs.update({url:e.url.replace("%s",r)});e.domain=e.url.split("/")[2].split(".")[1],e.domain==o&&(n=!0)}})),!1===s&&chrome.tabs.update({url:t[0].url.replace("%s",r)})}))}}))}));