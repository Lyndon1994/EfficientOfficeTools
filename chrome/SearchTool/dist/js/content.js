var addonConfig={engines:chrome.i18n.getMessage("defaultEnginesConfig"),select2clipboard:!1,showTooltip:!1,showTopSearchSwitch:!0,searchInNewTab:!0,themeStyle:"icon",themeColor:"rgba(144, 238, 144, 0.56)",textColor:"#202124"},selectTxt="",lasturl=window.location.href;function isHashChanged(){var e=window.location.href;return lasturl!=e&&(lasturl=e,!0)}function hashChange(){var e=document.getElementById("addon_toptooltip");e&&e.remove(),createTopTooltip()}function getSelectText(){var e="";return e=document.selection?document.selection.createRange().text:document.getSelection(),e.toString().trim()}function removeTooltip(){var e=document.getElementById("addon_tooltip");e&&e.remove()}function copySelectTxt(){navigator.clipboard.writeText(selectTxt).then((()=>{})).catch((e=>{console.log(`Copy failed! ${e}`)}))}function createTooltip(e){var o=e.pageX,t=e.pageY,n=`<div id="strong_search_menu_id" class="addon_xlj_toobar" style="position: absolute; left: {x}px; top: {y}px; z-index: 100000000; background-color: ${addonConfig.themeColor}; color: ${addonConfig.textColor};">`,a=/(\w+[^\s]+(\.[^\s]+){1,})/,d=a.exec(selectTxt);if(d){var i=d[1].trim(),l=chrome.i18n.getMessage("open"),s=`<a class="addon_xlj_copy_toobar addon_xlj_button" style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${i}">\n        <img class="addon_xlj_search_icon" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNjUxNTgwNDU1NTcwIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9Ijk0MiIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZGVmcz48c3R5bGUgdHlwZT0idGV4dC9jc3MiPjwvc3R5bGU+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjZmZmZmZmIiBwLWlkPSI5NDMiPjwvcGF0aD48cGF0aCBkPSJNNzY4IDgzMkgxOTJWMjU2aDM1MnYtNjRIMTYwYTMyIDMyIDAgMCAwLTMyIDMydjY0MGEzMiAzMiAwIDAgMCAzMiAzMmg2NDBhMzIgMzIgMCAwIDAgMzItMzJWNDgwaC02NHYzNTJ6IiBmaWxsPSIjZmZmZmZmIiBwLWlkPSI5NDQiPjwvcGF0aD48L3N2Zz4=">\n        <div class="addon_xlj_func">${l}</div></a>`;n+=s}var r=chrome.i18n.getMessage("copy");if(!addonConfig.select2clipboard){let e="📋";s=`<div class="addon_xlj_copy_toobar addon_xlj_button" style="font-size:20px;line-height:22px;cursor:pointer;color:${addonConfig.textColor};" title="${r}" onclick="navigator.clipboard.writeText('${selectTxt}')">\n        ${e}\n      </div>`,n+=s}var c='<div class="addon_xlj_button">',m=0;if(addonConfig.engines.forEach((e=>{if(e.name&&e.url&&e.inTooltip){m+=1;var o=e.url.replace("%s",encodeURIComponent(selectTxt));if("text"==addonConfig.themeStyle||!e.icon&&!e.iconData)c+=`<div class="addon_xlj_search_parts_engine addon_xlj_link_color" data-url="${o}" title="${e.name}"><a style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${o}">${e.name}</a></div>`;else{var t=e.iconData||e.icon;c+=`<a class="addon_xlj_search_parts_engine" style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${o}"><img style="width: 22px; height: 22px;" src="${t}" alt="${e.name}"></a>`}}})),c+="</div>",m>0&&(n+=c),0!=m||!addonConfig.select2clipboard){n+="</div>",n=n.replace("{x}",o+5).replace("{y}",t+20);var g=document.createElement("div");g.id="addon_tooltip",g.innerHTML=n,document.body.appendChild(g)}}function createTopTooltip(){console.log("createTopTooltip");var e=`<div id="strong_search_menu_id" class="addon_xlj_toobar" style="position: fixed; left: 60%; top: 0px; z-index: 100000000; background-color: ${addonConfig.themeColor}; color: ${addonConfig.textColor};">`,o=0,t='<div class="addon_xlj_button">';"black"!=addonConfig.themeColor&&(t='<div style="border-right: 0px;" class="addon_xlj_button">');var n=parseUrl(window.location.href),a=n["wd"]||n["word"]||n["query"]||n["q"]||n["w"]||"";if(a=decodeURI(a),a&&(addonConfig.engines.forEach((e=>{if(e.name&&e.url&&e.inPopup){o+=1;var n=e.url.replace("%s",a);if("text"==addonConfig.themeStyle||!e.icon&&!e.iconData)t+=`<div class="addon_xlj_search_parts_engine addon_xlj_link_color" data-url="${n}" title="${e.name}"><a style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${n}">${e.name}</a></div>`;else{var d=e.iconData||e.icon;t+=`<a class="addon_xlj_search_parts_engine" style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${n}"><img style="width: 22px; height: 22px;" src="${d}" alt="${e.name}"></a>`}}})),t+="</div>",!(o<=0))){e+=t,"black"!=addonConfig.themeColor?e+=`<div class="addon_xlj_copy_toobar addon_xlj_button" title="close" style="color:${addonConfig.textColor};" onclick="document.getElementById('addon_toptooltip').remove()">\n        <div class="addon_xlj_func">X</div></div>`:e+=`<div class="addon_xlj_copy_toobar addon_xlj_button" title="close" style="color:${addonConfig.textColor};" onclick="document.getElementById('addon_toptooltip').remove()">\n        <div class="addon_xlj_func addon_xlj_link_color">X</div></div>`,e+="</div>";var d=document.createElement("div");d.id="addon_toptooltip",d.innerHTML=e,document.body.appendChild(d)}}function parseUrl(e){var o={},t=/([^?=&]+)=([^?=&]+)/g;return e.replace(t,(function(){o[arguments[1]]=arguments[2]})),o}function showSummaryDialog(e){let o=document.getElementById("addon_summary_dialog");o&&o.remove();let t=e,n="";document.body?n=document.body.innerText||"":document.documentElement&&(n=document.documentElement.innerText||"");let a=[],d=document.createElement("div");function i(e,o){const t=document.getElementById("addon_summary_dialog_chat"),n=document.createElement("div");let a="";a="user"===e?chrome.i18n.getMessage("llmUserLabel")||"🧑":chrome.i18n.getMessage("llmAssistantLabel")||"🤖",n.style.margin="8px 0",n.innerHTML=`<b>${a}:</b> <span>${o}</span>`,t.appendChild(n),t.scrollTop=t.scrollHeight}function l(){const e=document.getElementById("addon_summary_dialog_input"),o=e.value.trim();if(!o)return;i("user",o);const d=[{role:"system",content:chrome.i18n.getMessage("llmPageContentPrefix")+(n||"")},{role:"assistant",content:t},...a,{role:"user",content:o}];e.value="",i("assistant",chrome.i18n.getMessage("llmThinking")||"思考中..."),chrome.runtime.sendMessage({action:"chatWithLLM",history:d},(function(e){const t=document.getElementById("addon_summary_dialog_chat");t.lastChild&&t.lastChild.innerText.includes(chrome.i18n.getMessage("llmThinking")||"思考中")&&t.removeChild(t.lastChild),e&&e.reply?(i("assistant",e.reply),a.push({role:"user",content:o}),a.push({role:"assistant",content:e.reply})):i("assistant",chrome.i18n.getMessage("llmChatFailed")||"对话失败，请重试。")}))}d.id="addon_summary_dialog",d.style.position="fixed",d.style.top="10%",d.style.left="50%",d.style.transform="translateX(-50%)",d.style.background="#fff",d.style.color="#222",d.style.padding="24px 32px",d.style.border="1px solid #888",d.style.borderRadius="8px",d.style.zIndex=999999999,d.style.boxShadow="0 4px 24px rgba(0,0,0,0.15)",d.style.maxWidth="600px",d.style.maxHeight="60vh",d.style.overflowY="auto",d.innerHTML=`\n    <div style="font-weight:bold;margin-bottom:8px;">总结全文</div>\n    <div style="white-space:normal;" id="addon_summary_dialog_content">${t}</div>\n    <div id="addon_summary_dialog_chat" style="margin-top:16px;"></div>\n    <div style="display:flex;gap:8px;margin-top:12px;">\n      <input id="addon_summary_dialog_input" type="text" style="flex:1;padding:4px 8px;" placeholder="继续提问...">\n      <button id="addon_summary_dialog_send" style="padding:4px 16px;">发送</button>\n      <button id="addon_summary_dialog_close" style="padding:4px 16px;">关闭</button>\n    </div>\n  `,document.body.appendChild(d),document.getElementById("addon_summary_dialog_close").onclick=function(){d.remove()},document.getElementById("addon_summary_dialog_send").onclick=l,document.getElementById("addon_summary_dialog_input").addEventListener("keydown",(function(e){"Enter"===e.key&&l()}))}function showLLMChatDialog(e,o){let t=document.getElementById("addon_summary_dialog");t&&t.remove();let n="",a=[],d=document.createElement("div");function i(e,o){const t=document.getElementById("addon_summary_dialog_chat"),n=document.createElement("div");let a="";a="user"===e?chrome.i18n.getMessage("llmUserLabel")||"🧑":chrome.i18n.getMessage("llmAssistantLabel")||"🤖",n.style.margin="8px 0",n.innerHTML=`<b>${a}:</b> <span>${o}</span>`,t.appendChild(n),t.scrollTop=t.scrollHeight}function l(){i("user",o),i("assistant",chrome.i18n.getMessage("llmThinking")||"思考中...");const t=[{role:"user",content:e.prompt.replace("{content}",o)}];chrome.runtime.sendMessage({action:"chatWithLLMMenu",menu:e,history:t},(function(t){const n=document.getElementById("addon_summary_dialog_chat");n.lastChild&&n.lastChild.innerText.includes(chrome.i18n.getMessage("llmThinking")||"思考中")&&n.removeChild(n.lastChild),t&&t.reply?(i("assistant",t.reply),a.push({role:"user",content:e.prompt.replace("{content}",o)}),a.push({role:"assistant",content:t.reply})):i("assistant",chrome.i18n.getMessage("llmChatFailed")||"对话失败，请重试。")}))}function s(){const o=document.getElementById("addon_summary_dialog_input"),t=o.value.trim();if(!t)return;i("user",t),o.value="",i("assistant",chrome.i18n.getMessage("llmThinking")||"思考中...");const n=[...a,{role:"user",content:t}];chrome.runtime.sendMessage({action:"chatWithLLMMenu",menu:e,history:n},(function(e){const o=document.getElementById("addon_summary_dialog_chat");o.lastChild&&o.lastChild.innerText.includes(chrome.i18n.getMessage("llmThinking")||"思考中")&&o.removeChild(o.lastChild),e&&e.reply?(i("assistant",e.reply),a.push({role:"user",content:t}),a.push({role:"assistant",content:e.reply})):i("assistant",chrome.i18n.getMessage("llmChatFailed")||"对话失败，请重试。")}))}d.id="addon_summary_dialog",d.style.position="fixed",d.style.top="10%",d.style.left="50%",d.style.transform="translateX(-50%)",d.style.background="#fff",d.style.color="#222",d.style.padding="24px 32px",d.style.border="1px solid #888",d.style.borderRadius="8px",d.style.zIndex=999999999,d.style.boxShadow="0 4px 24px rgba(0,0,0,0.15)",d.style.maxWidth="600px",d.style.maxHeight="60vh",d.style.overflowY="auto",d.innerHTML=`\n    <div style="font-weight:bold;margin-bottom:8px;">${e.name||"对话助手"}</div>\n    <div style="white-space:normal;" id="addon_summary_dialog_content">${n}</div>\n    <div id="addon_summary_dialog_chat" style="margin-top:16px;"></div>\n    <div style="display:flex;gap:8px;margin-top:12px;">\n      <input id="addon_summary_dialog_input" type="text" style="flex:1;padding:4px 8px;" placeholder="请输入...">\n      <button id="addon_summary_dialog_send" style="padding:4px 16px;">发送</button>\n      <button id="addon_summary_dialog_close" style="padding:4px 16px;">关闭</button>\n    </div>\n  `,document.body.appendChild(d),document.getElementById("addon_summary_dialog_close").onclick=function(){d.remove()},document.getElementById("addon_summary_dialog_send").onclick=s,document.getElementById("addon_summary_dialog_input").addEventListener("keydown",(function(e){"Enter"===e.key&&s()})),l()}chrome.storage.sync.get(addonConfig,(function(e){addonConfig.engines=JSON.parse(e.engines),chrome.storage.local.get(null,(function(o){if(addonConfig.engines.forEach((e=>{o&&o["iconData_"+e.name]&&(e.icon=o["iconData_"+e.name])})),addonConfig.select2clipboard=e.select2clipboard,addonConfig.showTooltip=e.showTooltip,addonConfig.showTopSearchSwitch=e.showTopSearchSwitch,addonConfig.searchInNewTab=e.searchInNewTab,addonConfig.themeColor=e.themeColor,addonConfig.textColor=e.textColor||"#202124",addonConfig.showTopSearchSwitch){var t=document.domain.split("."),n=!1;if(t.length>=2){var a=t[1];2!=t.length&&"com"!=a||(a=t[0]),addonConfig.engines.forEach((e=>{e.url&&e.inPopup&&-1!=e.url.indexOf(a)&&(n=!0)})),"baidu"!=a&&"google"!=a||setInterval((function(){var e=isHashChanged();e&&hashChange()}),3e3)}n&&createTopTooltip()}return!0}))})),document.addEventListener("mouseup",(function(e){selectTxt=getSelectText(),addonConfig.select2clipboard&&copySelectTxt(),setTimeout((function(){removeTooltip(),addonConfig.showTooltip&&selectTxt&&createTooltip(e)}),100)})),console.debug("[ContentScript] content script loaded"),chrome.runtime.onMessage.addListener((function(e,o,t){return console.debug("[ContentScript] onMessage",e),"getPageContent"===e.action?(t({content:document.body?document.body.innerText:document.documentElement.innerText}),!0):"showSummaryDialog"===e.action?(showSummaryDialog(e.summary),!0):"showLLMChatDialog"===e.action&&e.menu?(showLLMChatDialog(e.menu,e.selectionText||""),!0):void 0}));