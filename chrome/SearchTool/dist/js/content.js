var addonConfig={engines:chrome.i18n.getMessage("defaultEnginesConfig"),select2clipboard:!1,showTooltip:!1,showTopSearchSwitch:!0,searchInNewTab:!0,themeStyle:"icon",themeColor:"rgba(144, 238, 144, 0.56)",textColor:"#202124"},selectTxt="",lasturl=window.location.href;function isHashChanged(){var o=window.location.href;return lasturl!=o&&(lasturl=o,!0)}function hashChange(){var o=document.getElementById("addon_toptooltip");o&&o.remove(),createTopTooltip()}function getSelectText(){var o="";return o=document.selection?document.selection.createRange().text:document.getSelection(),o.toString().trim()}function removeTooltip(){var o=document.getElementById("addon_tooltip");o&&o.remove()}function copySelectTxt(){navigator.clipboard.writeText(selectTxt).then((()=>{})).catch((o=>{console.log(`Copy failed! ${o}`)}))}function createTooltip(o){var e=o.pageX,n=o.pageY,t=`<div id="strong_search_menu_id" class="addon_xlj_toobar" style="position: absolute; left: {x}px; top: {y}px; z-index: 100000000; background-color: ${addonConfig.themeColor}; color: ${addonConfig.textColor};">`,d=/(\w+[^\s]+(\.[^\s]+){1,})/,a=d.exec(selectTxt);if(a){var i=a[1].trim(),l=chrome.i18n.getMessage("open"),c=`<a class="addon_xlj_copy_toobar addon_xlj_button" style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${i}">\n        <img class="addon_xlj_search_icon" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNjUxNTgwNDU1NTcwIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9Ijk0MiIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZGVmcz48c3R5bGUgdHlwZT0idGV4dC9jc3MiPjwvc3R5bGU+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjZmZmZmZmIiBwLWlkPSI5NDMiPjwvcGF0aD48cGF0aCBkPSJNNzY4IDgzMkgxOTJWMjU2aDM1MnYtNjRIMTYwYTMyIDMyIDAgMCAwLTMyIDMydjY0MGEzMiAzMiAwIDAgMCAzMiAzMmg2NDBhMzIgMzIgMCAwIDAgMzItMzJWNDgwaC02NHYzNTJ6IiBmaWxsPSIjZmZmZmZmIiBwLWlkPSI5NDQiPjwvcGF0aD48L3N2Zz4=">\n        <div class="addon_xlj_func">${l}</div></a>`;t+=c}var r=chrome.i18n.getMessage("copy");if(!addonConfig.select2clipboard){let o="üìã";c=`<div class="addon_xlj_copy_toobar addon_xlj_button" style="font-size:20px;line-height:22px;cursor:pointer;color:${addonConfig.textColor};" title="${r}" onclick="navigator.clipboard.writeText('${selectTxt}')">\n        ${o}\n      </div>`,t+=c}var s='<div class="addon_xlj_button">',g=0;if(addonConfig.engines.forEach((o=>{if(o.name&&o.url&&o.inTooltip){g+=1;var e=o.url.replace("%s",encodeURIComponent(selectTxt));if("text"==addonConfig.themeStyle||!o.icon&&!o.iconData)s+=`<div class="addon_xlj_search_parts_engine addon_xlj_link_color" data-url="${e}" title="${o.name}"><a style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${e}">${o.name}</a></div>`;else{var n=o.iconData||o.icon;s+=`<a class="addon_xlj_search_parts_engine" style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${e}"><img style="width: 22px; height: 22px;" src="${n}" alt="${o.name}"></a>`}}})),s+="</div>",g>0&&(t+=s),0!=g||!addonConfig.select2clipboard){t+="</div>",t=t.replace("{x}",e+5).replace("{y}",n+20);var m=document.createElement("div");m.id="addon_tooltip",m.innerHTML=t,document.body.appendChild(m)}}function createTopTooltip(){console.log("createTopTooltip");var o=`<div id="strong_search_menu_id" class="addon_xlj_toobar" style="position: fixed; left: 60%; top: 0px; z-index: 100000000; background-color: ${addonConfig.themeColor}; color: ${addonConfig.textColor};">`,e=0,n='<div class="addon_xlj_button">';"black"!=addonConfig.themeColor&&(n='<div style="border-right: 0px;" class="addon_xlj_button">');var t=parseUrl(window.location.href),d=t["wd"]||t["word"]||t["query"]||t["q"]||t["w"]||"";if(d=decodeURI(d),d&&(addonConfig.engines.forEach((o=>{if(o.name&&o.url&&o.inPopup){e+=1;var t=o.url.replace("%s",d);if("text"==addonConfig.themeStyle||!o.icon&&!o.iconData)n+=`<div class="addon_xlj_search_parts_engine addon_xlj_link_color" data-url="${t}" title="${o.name}"><a style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${t}">${o.name}</a></div>`;else{var a=o.iconData||o.icon;n+=`<a class="addon_xlj_search_parts_engine" style="color:${addonConfig.textColor};" target="${addonConfig.searchInNewTab?"_blank":"_self"}" href="${t}"><img style="width: 22px; height: 22px;" src="${a}" alt="${o.name}"></a>`}}})),n+="</div>",!(e<=0))){o+=n,"black"!=addonConfig.themeColor?o+=`<div class="addon_xlj_copy_toobar addon_xlj_button" title="close" style="color:${addonConfig.textColor};" onclick="document.getElementById('addon_toptooltip').remove()">\n        <div class="addon_xlj_func">X</div></div>`:o+=`<div class="addon_xlj_copy_toobar addon_xlj_button" title="close" style="color:${addonConfig.textColor};" onclick="document.getElementById('addon_toptooltip').remove()">\n        <div class="addon_xlj_func addon_xlj_link_color">X</div></div>`,o+="</div>";var a=document.createElement("div");a.id="addon_toptooltip",a.innerHTML=o,document.body.appendChild(a)}}function parseUrl(o){var e={},n=/([^?=&]+)=([^?=&]+)/g;return o.replace(n,(function(){e[arguments[1]]=arguments[2]})),e}function showSummaryDialog(o){let e=document.getElementById("addon_summary_dialog");e&&e.remove();let n=o,t="";document.body?t=document.body.innerText||"":document.documentElement&&(t=document.documentElement.innerText||"");let d=[],a=document.createElement("div");function i(o,e){const n=document.getElementById("addon_summary_dialog_chat"),t=document.createElement("div");t.style.margin="8px 0",t.innerHTML=`<b>${"user"===o?"‰Ω†":"Âä©Êâã"}:</b> <span>${e}</span>`,n.appendChild(t),n.scrollTop=n.scrollHeight}function l(){const o=document.getElementById("addon_summary_dialog_input"),e=o.value.trim();if(!e)return;i("user",e);const a=[{role:"system",content:"‰ª•‰∏ãÊòØÁΩëÈ°µÊ≠£ÊñáÂÜÖÂÆπÔºö"+t},{role:"assistant",content:n},...d,{role:"user",content:e}];o.value="",i("assistant","ÊÄùËÄÉ‰∏≠..."),chrome.runtime.sendMessage({action:"chatWithLLM",history:a},(function(o){const n=document.getElementById("addon_summary_dialog_chat");n.lastChild&&n.lastChild.innerText.includes("ÊÄùËÄÉ‰∏≠")&&n.removeChild(n.lastChild),o&&o.reply?(i("assistant",o.reply),d.push({role:"user",content:e}),d.push({role:"assistant",content:o.reply})):i("assistant","ÂØπËØùÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ")}))}a.id="addon_summary_dialog",a.style.position="fixed",a.style.top="10%",a.style.left="50%",a.style.transform="translateX(-50%)",a.style.background="#fff",a.style.color="#222",a.style.padding="24px 32px",a.style.border="1px solid #888",a.style.borderRadius="8px",a.style.zIndex=999999999,a.style.boxShadow="0 4px 24px rgba(0,0,0,0.15)",a.style.maxWidth="600px",a.style.maxHeight="60vh",a.style.overflowY="auto",a.innerHTML=`\n    <div style="font-weight:bold;margin-bottom:8px;">ÊÄªÁªìÂÖ®Êñá</div>\n    <div style="white-space:normal;" id="addon_summary_dialog_content">${n}</div>\n    <div id="addon_summary_dialog_chat" style="margin-top:16px;"></div>\n    <div style="display:flex;gap:8px;margin-top:12px;">\n      <input id="addon_summary_dialog_input" type="text" style="flex:1;padding:4px 8px;" placeholder="ÁªßÁª≠ÊèêÈóÆ...">\n      <button id="addon_summary_dialog_send" style="padding:4px 16px;">ÂèëÈÄÅ</button>\n      <button id="addon_summary_dialog_close" style="padding:4px 16px;">ÂÖ≥Èó≠</button>\n    </div>\n  `,document.body.appendChild(a),document.getElementById("addon_summary_dialog_close").onclick=function(){a.remove()},document.getElementById("addon_summary_dialog_send").onclick=l,document.getElementById("addon_summary_dialog_input").addEventListener("keydown",(function(o){"Enter"===o.key&&l()}))}chrome.storage.sync.get(addonConfig,(function(o){addonConfig.engines=JSON.parse(o.engines),chrome.storage.local.get(null,(function(e){if(addonConfig.engines.forEach((o=>{e&&e["iconData_"+o.id]&&(o.icon=e["iconData_"+o.id])})),addonConfig.select2clipboard=o.select2clipboard,addonConfig.showTooltip=o.showTooltip,addonConfig.showTopSearchSwitch=o.showTopSearchSwitch,addonConfig.searchInNewTab=o.searchInNewTab,addonConfig.themeColor=o.themeColor,addonConfig.textColor=o.textColor||"#202124",addonConfig.showTopSearchSwitch){var n=document.domain.split("."),t=!1;if(n.length>=2){var d=n[1];2!=n.length&&"com"!=d||(d=n[0]),addonConfig.engines.forEach((o=>{o.url&&o.inPopup&&-1!=o.url.indexOf(d)&&(t=!0)})),"baidu"!=d&&"google"!=d||setInterval((function(){var o=isHashChanged();o&&hashChange()}),3e3)}t&&createTopTooltip()}return!0}))})),document.addEventListener("mouseup",(function(o){selectTxt=getSelectText(),addonConfig.select2clipboard&&copySelectTxt(),setTimeout((function(){removeTooltip(),addonConfig.showTooltip&&selectTxt&&createTooltip(o)}),100)})),console.debug("[ContentScript] content script loaded"),chrome.runtime.onMessage.addListener((function(o,e,n){return console.debug("[ContentScript] onMessage",o),"getPageContent"===o.action?(n({content:document.body?document.body.innerText:document.documentElement.innerText}),!0):"showSummaryDialog"===o.action?(showSummaryDialog(o.summary),!0):void 0}));